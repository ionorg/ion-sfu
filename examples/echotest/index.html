<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
      crossorigin="anonymous"
    />

    <style>
      pre {
        outline: 1px solid #ccc;
        padding: 5px;
        margin: 5px;
      }

      .string {
        color: green;
      }

      .number {
        color: darkorange;
      }

      .boolean {
        color: blue;
      }

      .null {
        color: magenta;
      }

      .key {
        color: red;
      }
    </style>

    <title>Pion ion-sfu | Echotest</title>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light border-bottom">
      <h3>Pion</h3>
    </nav>
    <div class="container pt-4">
      <div class="row" id="start-btns">
        <div class="col-12">
          <button type="button" class="btn btn-primary" onclick="start(false)">
            start
          </button>
          <button type="button" class="btn btn-primary" onclick="start(true)">
            start with simulcast
          </button>
        </div>
      </div>
      <div class="row pt-3" id="controls" style="display: none">
        <div class="col-3">
          <strong>Video</strong>
          <div id="simulcast-controls" style="display: none">
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="high"
                  name="optvideos"
                  checked
                />
                High</label
              >
            </div>
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="medium"
                  name="optvideos"
                />
                Medium</label
              >
            </div>
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="low"
                  name="optvideos"
                />
                Low</label
              >
            </div>
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="none"
                  name="optvideos"
                />
                Mute</label
              >
            </div>
          </div>

          <div id="simple-controls" style="display: none">
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="high"
                  name="optvideo"
                  checked
                />
                Unmute</label
              >
            </div>
            <div class="radio">
              <label
                ><input
                  type="radio"
                  onclick="controlVideo(this)"
                  value="none"
                  name="optvideo"
                />
                Mute</label
              >
            </div>
          </div>
        </div>
        <div class="col-3">
          <strong>Audio</strong>
          <div class="radio">
            <label
              ><input
                type="radio"
                onclick="controlAudio(this)"
                value="true"
                name="optaudio"
                checked
              />
              Unmute</label
            >
          </div>
          <div class="radio">
            <label
              ><input
                type="radio"
                onclick="controlAudio(this)"
                value="false"
                name="optaudio"
              />
              Mute</label
            >
          </div>
        </div>
        <div class="col-6">
          <strong>API call</strong>
          <pre
            id="api"
            class="d-block border"
            style="background-color: #f8f9fa; height: 117px"
          ></pre>
        </div>
      </div>
      <div class="row">
        <div class="col-6 pt-2">
          <span
            style="position: absolute; margin-left: 5px; margin-top: 5px"
            class="badge badge-primary"
            >Local</span
          >
          <video
            id="local-video"
            style="background-color: black"
            width="320"
            height="240"
          ></video>
        </div>
        <div class="col-6 pt-2">
          <span
            style="position: absolute; margin-left: 5px; margin-top: 5px"
            class="badge badge-primary"
            >Remote</span
          >
          <span
            id="size-tag"
            style="position: absolute; margin-left: 5px; top: 225px"
            class="badge badge-primary"
          ></span>
          <span
            id="br-tag"
            style="position: absolute; left: 270px; top: 225px"
            class="badge badge-primary"
          ></span>
          <video
            id="remote-video"
            style="background-color: black"
            width="320"
            height="240"
          ></video>
        </div>
      </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
      integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/ion-sdk-js@1.0.2/dist/ion-sdk.min.js"></script>
    <script>
      const localVideo = document.getElementById("local-video");
      const remoteVideo = document.getElementById("remote-video");
      const sizeTag = document.getElementById("size-tag");
      const brTag = document.getElementById("br-tag");
      let simulcast = false;

      remoteVideo.addEventListener("loadedmetadata", function () {
        sizeTag.innerHTML = `${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`;
      });

      remoteVideo.onresize = function () {
        sizeTag.innerHTML = `${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`;
      };

      /* eslint-env browser */
      const joinBtns = document.getElementById("start-btns");

      const config = {
        iceServers: [
          {
            urls: "stun:stun.l.google.com:19302",
          },
        ],
      };

      const signalLocal = new IonSDK.IonSFUJSONRPCSignal(
        "ws://localhost:7000/ws"
      );
      const signalRemote = new IonSDK.IonSFUJSONRPCSignal(
        "ws://localhost:7000/ws"
      );

      const clientLocal = new IonSDK.Client("test session", signalLocal);
      const clientRemote = new IonSDK.Client("test session", signalRemote);

      const start = (sc) => {
        simulcast = sc;
        const localStream = IonSDK.LocalStream.getUserMedia({
          resolution: "hd",
          simulcast: sc,
        })
          .then((stream) => {
            localVideo.srcObject = stream;
            localVideo.autoplay = true;
            localVideo.controls = true;
            localVideo.muted = true;
            joinBtns.style.display = "none";
            clientLocal.publish(stream);
          })
          .catch(console.error);
      };

      let remoteStream;
      clientRemote.ontrack = (track, stream) => {
        if (track.kind === "video") {
          remoteStream = stream;
          remoteVideo.srcObject = stream;
          remoteVideo.autoplay = true;

          getStats();

          document.getElementById("controls").style.display = "flex";
          if (simulcast) {
            document.getElementById("simulcast-controls").style.display =
              "block";
          } else {
            document.getElementById("simple-controls").style.display = "block";
          }
        }
      };

      const api = {
        streamId: "",
        video: "high",
        audio: true,
      };

      const controlVideo = (radio) => {
        remoteStream.preferLayer(radio.value);

        // update ui
        api.video = radio.value;
        const str = JSON.stringify(api, null, 2);
        document.getElementById("api").innerHTML = syntaxHighlight(str);
      };

      const controlAudio = (radio) => {
        if (radio.value === "true") {
          remoteStream.mute("audio");
        } else {
          remoteStream.unmute("audio");
        }

        // update ui
        api.audio = radio.value === "true";
        const str = JSON.stringify(api, null, 2);
        document.getElementById("api").innerHTML = syntaxHighlight(str);
      };

      function syntaxHighlight(json) {
        json = json
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            let cls = "number";
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = "key";
              } else {
                cls = "string";
              }
            } else if (/true|false/.test(match)) {
              cls = "boolean";
            } else if (/null/.test(match)) {
              cls = "null";
            }
            return '<span class="' + cls + '">' + match + "</span>";
          }
        );
      }

      getStats = () => {
        let bytesPrev;
        let timestampPrev;
        setInterval(() => {
          clientRemote.getStats(null).then((results) => {
            results.forEach((report) => {
              const now = report.timestamp;

              let bitrate;
              if (
                report.type === "inbound-rtp" &&
                report.mediaType === "video"
              ) {
                const bytes = report.bytesReceived;
                if (timestampPrev) {
                  bitrate = (8 * (bytes - bytesPrev)) / (now - timestampPrev);
                  bitrate = Math.floor(bitrate);
                }
                bytesPrev = bytes;
                timestampPrev = now;
              }
              if (bitrate) {
                brTag.innerHTML = `${bitrate} kbps`;
              }
            });
          });
        }, 1000);
      };
    </script>
  </body>
</html>
